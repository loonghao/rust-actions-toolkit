name: CI

# CI workflow for rust-actions-toolkit
# Tests the GitHub Actions toolkit itself
# Validates action.yml files and ensures everything works correctly

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, develop]

permissions:
  contents: read
  actions: read

jobs:
  # Validate GitHub Actions
  validate-actions:
    name: Validate Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate main action.yml
        run: |
          if [ ! -f action.yml ]; then
            echo "‚ùå action.yml not found"
            exit 1
          fi

          # Check required fields
          if ! grep -q "name:" action.yml; then
            echo "‚ùå Missing 'name' field in action.yml"
            exit 1
          fi

          if ! grep -q "description:" action.yml; then
            echo "‚ùå Missing 'description' field in action.yml"
            exit 1
          fi

          if ! grep -q "branding:" action.yml; then
            echo "‚ùå Missing 'branding' field in action.yml"
            exit 1
          fi

          echo "‚úÖ Main action.yml validation passed"

      - name: Validate composite actions
        run: |
          for action_dir in actions/*/; do
            if [ -d "$action_dir" ]; then
              action_file="${action_dir}action.yml"
              if [ ! -f "$action_file" ]; then
                echo "‚ùå Missing action.yml in $action_dir"
                exit 1
              fi

              if ! grep -q "name:" "$action_file"; then
                echo "‚ùå Missing 'name' field in $action_file"
                exit 1
              fi

              if ! grep -q "description:" "$action_file"; then
                echo "‚ùå Missing 'description' field in $action_file"
                exit 1
              fi

              echo "‚úÖ $action_file validation passed"
            fi
          done

      - name: Validate reusable workflows
        run: |
          for workflow in .github/workflows/reusable-*.yml; do
            if [ -f "$workflow" ]; then
              if ! grep -q "workflow_call:" "$workflow"; then
                echo "‚ùå $workflow is not a reusable workflow"
                exit 1
              fi
              echo "‚úÖ $workflow validation passed"
            fi
          done

  # Test our composite actions
  test-actions:
    name: Test Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test setup-rust-ci action
        uses: ./actions/setup-rust-ci
        with:
          toolchain: stable
          check-format: false
          check-clippy: false
          check-docs: false

      - name: Verify Rust installation
        run: |
          rustc --version
          cargo --version
          echo "‚úÖ Rust toolchain installed successfully"

  # Test new setup-build-env action
  test-build-env:
    name: Test Build Environment Setup
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
          - os: ubuntu-22.04
            target: x86_64-pc-windows-gnu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test setup-build-env action
        uses: ./.github/actions/setup-build-env
        with:
          target: ${{ matrix.target }}
          os: ${{ matrix.os }}
          rust-toolchain: stable

      - name: Verify environment setup
        run: |
          echo "üîç Verifying build environment..."
          rustc --version
          cargo --version

          # Check if target is installed
          rustup target list --installed | grep "${{ matrix.target }}" || echo "‚ö†Ô∏è Target not found"

          # Test basic build (if we have a Cargo.toml)
          if [ -f "Cargo.toml" ]; then
            echo "Testing basic build..."
            cargo check --target ${{ matrix.target }} || echo "‚ö†Ô∏è Build check failed (expected for toolkit project)"
          fi

          echo "‚úÖ Build environment test completed"

  # Test documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README files exist
        run: |
          if [ ! -f README.md ]; then
            echo "‚ùå README.md not found"
            exit 1
          fi

          if [ ! -f README_zh.md ]; then
            echo "‚ùå README_zh.md not found"
            exit 1
          fi

          if [ ! -f USAGE.md ]; then
            echo "‚ùå USAGE.md not found"
            exit 1
          fi

          echo "‚úÖ Documentation files found"

      - name: Check examples exist
        run: |
          if [ ! -d examples ]; then
            echo "‚ùå examples directory not found"
            exit 1
          fi

          if [ ! -d examples/github-action ]; then
            echo "‚ùå examples/github-action directory not found"
            exit 1
          fi

          echo "‚úÖ Example files found"
