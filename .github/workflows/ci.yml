name: CI

# CI workflow for rust-actions-toolkit
# Tests the GitHub Actions toolkit itself
# Validates action.yml files and ensures everything works correctly

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, develop]

permissions:
  contents: read
  actions: read

jobs:
  # Validate GitHub Actions
  validate-actions:
    name: Validate Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate main action.yml
        run: |
          if [ ! -f action.yml ]; then
            echo "❌ action.yml not found"
            exit 1
          fi

          # Check required fields
          if ! grep -q "name:" action.yml; then
            echo "❌ Missing 'name' field in action.yml"
            exit 1
          fi

          if ! grep -q "description:" action.yml; then
            echo "❌ Missing 'description' field in action.yml"
            exit 1
          fi

          if ! grep -q "branding:" action.yml; then
            echo "❌ Missing 'branding' field in action.yml"
            exit 1
          fi

          echo "✅ Main action.yml validation passed"

      - name: Validate composite actions
        run: |
          for action_dir in actions/*/; do
            if [ -d "$action_dir" ]; then
              action_file="${action_dir}action.yml"
              if [ ! -f "$action_file" ]; then
                echo "❌ Missing action.yml in $action_dir"
                exit 1
              fi

              if ! grep -q "name:" "$action_file"; then
                echo "❌ Missing 'name' field in $action_file"
                exit 1
              fi

              if ! grep -q "description:" "$action_file"; then
                echo "❌ Missing 'description' field in $action_file"
                exit 1
              fi

              echo "✅ $action_file validation passed"
            fi
          done

      - name: Validate reusable workflows
        run: |
          for workflow in .github/workflows/reusable-*.yml; do
            if [ -f "$workflow" ]; then
              if ! grep -q "workflow_call:" "$workflow"; then
                echo "❌ $workflow is not a reusable workflow"
                exit 1
              fi
              echo "✅ $workflow validation passed"
            fi
          done

  # Test our composite actions
  test-actions:
    name: Test Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test setup-rust-ci action
        uses: ./actions/setup-rust-ci
        with:
          toolchain: stable
          check-format: false
          check-clippy: false
          check-docs: false

      - name: Verify Rust installation
        run: |
          rustc --version
          cargo --version
          echo "✅ Rust toolchain installed successfully"

  # Test documentation
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README files exist
        run: |
          if [ ! -f README.md ]; then
            echo "❌ README.md not found"
            exit 1
          fi

          if [ ! -f README_zh.md ]; then
            echo "❌ README_zh.md not found"
            exit 1
          fi

          if [ ! -f USAGE.md ]; then
            echo "❌ USAGE.md not found"
            exit 1
          fi

          echo "✅ Documentation files found"

      - name: Check examples exist
        run: |
          if [ ! -d examples ]; then
            echo "❌ examples directory not found"
            exit 1
          fi

          if [ ! -d examples/github-action ]; then
            echo "❌ examples/github-action directory not found"
            exit 1
          fi

          echo "✅ Example files found"
